<!DOCTYPE html>
<html>
  <head>
    <title>The Immutables</title>
    <script src="raphael-min.js"></script>
    <script src="jquery.min.js"></script>
    <script src="underscore-min.js"></script>
  </head>
  <body>
    <canvas id="field"></canvas>
    <script type="text/javascript">
      var PIXEL_SIZE = 30;
      var LINE_WIDTH = 3;
      function Field(w, h) {
        this.canvas = this.initCanvas(w, h);
        this.context = this.canvas.getContext("2d");
        this.context.lineWidth = LINE_WIDTH;
        this.w = w;
        this.h = h;
        this.cursor = new Cursor(this, 0, 0);
        this.cells = _.range(w).map(function(x) { return _.range(h).map(function(y) { return 0 })});
        this.drawGrid();
        this.drawCursor();
        window.addEventListener("keydown", _.bind(this.onKeyDown, this), false);
        window.addEventListener("keyup", _.bind(this.onKeyUp, this), false);
      }

      Field.prototype = {
        initCanvas: function(w, h) {
          var canvas = $("#field").get(0);
          canvas.width = PIXEL_SIZE * w + LINE_WIDTH;
          canvas.height = PIXEL_SIZE * h + LINE_WIDTH;
          return canvas;
        },

        onKeyDown: function(e) {
          if (_.include([32, 37, 38, 39, 40], e.keyCode)) {
            e.preventDefault();
            var cursor = this.cursor;
            switch(e.keyCode) {
              case 37: cursor.moveLeft(); break;
              case 38: cursor.moveUp(); break;
              case 39: cursor.moveRight(); break;
              case 40: cursor.moveDown(); break;
              case 32: cursor.startPainting(); break;
            }
            this.repaint();
          }
        },
        onKeyUp: function(e) {
          if (e.keyCode === 32) {
            this.cursor.stopPainting();
          }
        },

        paint: function() {
          this.cells[this.cursor.x][this.cursor.y] = 1;
          this.repaint();
        },


        repaint: function() {
          this.drawGrid();
          this.drawCells();
          this.drawCursor();
        },

        drawGrid: function() {
          var ctx = this.context;
          ctx.beginPath();
          ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
          for (var x = 0; x <= this.w; x++) {
            ctx.moveTo(LINE_WIDTH / 2 + x*PIXEL_SIZE, 0);
            ctx.lineTo(LINE_WIDTH / 2 + x*PIXEL_SIZE, this.canvas.height);
          }
          for (var y = 0; y <= this.h; y ++) {
            ctx.moveTo(0, LINE_WIDTH / 2 + y*PIXEL_SIZE);
            ctx.lineTo(this.canvas.width, LINE_WIDTH / 2 + y*PIXEL_SIZE);
          }
          ctx.strokeStyle = "#ccc";
          ctx.stroke();
        },
        drawCells: function() {
          var ctx = this.context;
          var columns = this.cells;
          _.each(columns, function(column, x) {
            _.each(column, function(cell, y) {
              if (cell === 1) {
                drawCell(x, y);
              }
            });
          });
          function drawCell(i, j) {
            ctx.beginPath();
            ctx.fillStyle = "#f00";
            var x = i * PIXEL_SIZE + LINE_WIDTH;
            var y = j * PIXEL_SIZE + LINE_WIDTH;
            ctx.fillRect(x, y, PIXEL_SIZE - LINE_WIDTH, PIXEL_SIZE - LINE_WIDTH);
          }
        },

        drawCursor: function() {
          var ctx = this.context;
          ctx.beginPath();
          var x = this.cursor.x * PIXEL_SIZE + LINE_WIDTH / 2;
          var y = this.cursor.y * PIXEL_SIZE + LINE_WIDTH / 2;
          ctx.strokeStyle = "#999";
          ctx.strokeRect(x, y, PIXEL_SIZE, PIXEL_SIZE);
        },
      }

      function Cursor(field, x, y) {
        this.field = field;
        this.x = x || 0;
        this.y = y || 0;
      }

      Cursor.prototype = {
        move: function(dx, dy) {
          this.x += dx;
          this.y += dy;
          if (this.x < 0 ) { this.x = 0 };
          if (this.y < 0 ) { this.y = 0 };
          if (this.x >= this.w) { this.x = this.w - 1 };
          if (this.y >= this.h) { this.y = this.h - 1 };
          if (this.isPainting) {
            this.field.paint();
          }
        },

        moveLeft:  function() { this.move(-1, 0); },
        moveRight: function() { this.move(1, 0); },
        moveUp: function() { this.move(0, -1); },
        moveDown: function() { this.move(0, 1); },

        startPainting: function() {
          this.isPainting = true;
          this.field.paint();
        },

        stopPainting: function() {
          this.isPainting = false;
        }
      }

      var field = new Field(10, 10);
    </script>
  </body>
</html>
